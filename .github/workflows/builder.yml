name: Build BARA Firmware

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python (required by arduino-cli)
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install arduino-cli
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Initialize arduino-cli
        run: |
          arduino-cli core update-index
          arduino-cli core install esp32:esp32
          arduino-cli lib install "ESPAsyncWebServer" "AsyncTCP" "ArduinoJson" "DNSServer"

      - name: Compile sketch
        run: |
          arduino-cli compile --fqbn esp32:esp32:esp32 --build-path ./build ./bara.ino

      - name: Merge binary (bootloader + partitions + app)
        run: |
          python3 -c "
import sys, os, struct
bootloader = './build/bara.ino.bootloader.bin'
partitions = './build/bara.ino.partitions.bin'
app = './build/bara.ino.bin'
merged = 'merged.bin'

# ESP32 default offsets
BOOTLOADER_ADDR = 0x1000
PARTITIONS_ADDR = 0x8000
APP_ADDR = 0x10000

# Create 4MB flash image filled with 0xFF (common practice)
flash_size = 4 * 1024 * 1024
flash = bytearray([0xFF] * flash_size)

def write_file_at_offset(filename, offset):
    if os.path.exists(filename):
        with open(filename, 'rb') as f:
            data = f.read()
            flash[offset:offset + len(data)] = data
            print(f'Wrote {filename} at 0x{offset:06X}')
    else:
        print(f'Warning: {filename} not found')

write_file_at_offset(bootloader, BOOTLOADER_ADDR)
write_file_at_offset(partitions, PARTITIONS_ADDR)
write_file_at_offset(app, APP_ADDR)

with open(merged, 'wb') as f:
    f.write(flash)
print(f'âœ… Merged binary created: {merged} (4MB, app at 0x{APP_ADDR:X})')
"

      - name: Upload merged.bin artifact
        uses: actions/upload-artifact@v4
        with:
          name: BARA_firmware
          path: merged.bin
