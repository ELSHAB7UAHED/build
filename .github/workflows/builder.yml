# ============================================================================
# ğŸ©¸ BARA â€” ESP32 FIRMWARE AUTOMATED BUILDER (GITHUB ACTIONS)
# Developed by Ahmed Nour Ahmed | Qena, Egypt
# ============================================================================
name: ğŸ©¸ Build BARA Firmware for ESP32

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:  # Manual trigger

jobs:
  build:
    name: ğŸ”¥ Build ESP32 Binary
    runs-on: ubuntu-24.04

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Arduino CLI
        uses: arduino/setup-arduino-cli@main  # âœ… Fixed: v1.5.0 doesn't exist

      - name: ğŸ”Œ Add ESP32 Core
        run: |
          arduino-cli core update-index --additional-urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
          arduino-cli core install esp32:esp32 --additional-urls https://espressif.github.io/arduino-esp32/package_esp32_index.json

      - name: ğŸ“¦ Install Libraries
        run: |
          arduino-cli lib install \
            "ESPAsyncWebServer" \
            "AsyncTCP" \
            "ArduinoJson" \
            "DNSServer"

      - name: ğŸ› ï¸ Compile Project
        run: |
          arduino-cli compile \
            --fqbn esp32:esp32:esp32 \
            --build-property compiler.cpp.extra_flags="-DBARA_PRO" \
            --output-dir ./build \
            bara.ino

      - name: ğŸ“‚ Prepare Firmware Directory
        run: |
          mkdir -p firmware
          cp ./build/*firmware*.bin ./firmware/bara-firmware.bin 2>/dev/null || echo "âš ï¸ Firmware bin not found"
          cp ./build/*partitions*.bin ./firmware/bara-partitions.bin 2>/dev/null || echo "âš ï¸ Partitions bin not found"
          cp ./build/*bootloader*.bin ./firmware/bara-bootloader.bin 2>/dev/null || echo "âš ï¸ Bootloader bin not found"

      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bara-esp32-binaries
          path: ./firmware/
          retention-days: 30

      - name: ğŸ§¾ Summary
        run: |
          echo "âœ… BARA build completed!"
          echo "ğŸ“ Output files:"
          ls -lh ./firmware/
