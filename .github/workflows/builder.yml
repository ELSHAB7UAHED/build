# ============================================================================
# ğŸ©¸ BARA BUILD WORKFLOW â€” AUTOMATIC BIN GENERATOR FOR ESP32 ğŸ©¸
# Developed by Ahmed Nour Ahmed | Qena, Egypt
# ============================================================================
name: ğŸ©¸ Build BARA Firmware

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  build:
    name: ğŸ”¥ Build for ESP32
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Set up Arduino CLI
        uses: arduino/setup-arduino-cli@v1.5.0

      - name: ğŸ”Œ Add ESP32 Board Support
        run: |
          arduino-cli core update-index --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli core install esp32:esp32 --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

      - name: ğŸ“¦ Install Required Libraries
        run: |
          arduino-cli lib install \
            "ESPAsyncWebServer" \
            "AsyncTCP" \
            "ArduinoJson" \
            "DNSServer"

      - name: ğŸ› ï¸ Compile BARA Firmware
        run: |
          arduino-cli compile \
            --fqbn esp32:esp32:esp32 \
            --build-property compiler.cpp.extra_flags="-DBARA_PRODUCTION" \
            --output-dir ./build \
            bara.ino

      - name: ğŸ“‚ Ensure build directory exists
        run: mkdir -p ./firmware

      - name: ğŸ”„ Rename and organize output files
        run: |
          mv ./build/*firmware*.bin ./firmware/bara-firmware.bin || echo "Firmware bin not found"
          mv ./build/*partitions*.bin ./firmware/bara-partitions.bin || echo "Partitions bin not found"
          mv ./build/*bootloader*.bin ./firmware/bara-bootloader.bin || echo "Bootloader bin not found"

      - name: ğŸ“¤ Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bara-esp32-firmware
          path: ./firmware/
          retention-days: 30

      - name: âœ… Build Summary
        run: |
          echo "ğŸ§¾ BARA firmware built successfully!"
          echo "ğŸ“ Artifacts: bara-firmware.bin, bara-partitions.bin, bara-bootloader.bin"
          ls -lh ./firmware/
