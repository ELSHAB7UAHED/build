# ============================================================================
# ğŸ©¸ BARA â€” ESP32 FIRMWARE AUTOMATED BUILDER (GITHUB ACTIONS)
# Developed by Ahmed Nour Ahmed | Qena, Egypt
# ============================================================================
name: ğŸ©¸ Build BARA Firmware for ESP32

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    name: ğŸ”¥ Build ESP32 Binary
    runs-on: ubuntu-24.04

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1.4.0  # âœ… CORRECT VERSION

      - name: ğŸ”Œ Add ESP32 Core
        run: |
          arduino-cli core update-index --additional-urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
          arduino-cli core install esp32:esp32 --additional-urls https://espressif.github.io/arduino-esp32/package_esp32_index.json

      - name: ğŸ“¦ Install Required Libraries
        run: |
          arduino-cli lib install \
            "ESPAsyncWebServer" \
            "AsyncTCP" \
            "ArduinoJson" \
            "DNSServer"

      - name: ğŸ› ï¸ Compile Project
        run: |
          arduino-cli compile \
            --fqbn esp32:esp32:esp32 \
            --build-property compiler.cpp.extra_flags="-DBARA_PRO" \
            --output-dir ./build \
            bara.ino

      - name: ğŸ“‚ Prepare Firmware Directory
        run: |
          mkdir -p firmware
          find ./build -name "*firmware*.bin" -exec cp {} ./firmware/bara-firmware.bin \; || echo "âš ï¸ Firmware not found"
          find ./build -name "*partitions*.bin" -exec cp {} ./firmware/bara-partitions.bin \; || echo "âš ï¸ Partitions not found"
          find ./build -name "*bootloader*.bin" -exec cp {} ./firmware/bara-bootloader.bin \; || echo "âš ï¸ Bootloader not found"

      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bara-esp32-binaries
          path: ./firmware/
          retention-days: 30

      - name: ğŸ§¾ Build Summary
        run: |
          echo "âœ… BARA build succeeded!"
          ls -lh ./firmware/
