# builder.yml
name: Build BARA Firmware for ESP32

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install PlatformIO Core
        run: pip install platformio

      - name: Install required libraries
        run: |
          pio pkg install --lib "me-no-dev/ESPAsyncWebServer"
          pio pkg install --lib "bblanchon/ArduinoJson"

      - name: Build firmware
        run: pio run -e esp32dev

      - name: Merge binaries into merged.bin (offset 0x0)
        run: |
          pio run -t buildprog
          python3 -c "
import os, sys
from pathlib import Path

build_dir = Path('.pio/build/esp32dev')
bootloader = build_dir / 'bootloader.bin'
partitions = build_dir / 'partitions.bin'
firmware = build_dir / 'firmware.bin'
merged = 'merged.bin'

# Get flash offsets
BOOTLOADER_OFFSET = 0x1000
PARTITIONS_OFFSET = 0x8000
FIRMWARE_OFFSET = 0x10000

# Create empty file up to FIRMWARE_OFFSET + size
with open(merged, 'wb') as f:
    f.write(b'\xff' * (FIRMWARE_OFFSET + firmware.stat().st_size))

def write_at_offset(file_path, offset):
    with open(file_path, 'rb') as src, open(merged, 'r+b') as dst:
        dst.seek(offset)
        dst.write(src.read())

write_at_offset(bootloader, BOOTLOADER_OFFSET)
write_at_offset(partitions, PARTITIONS_OFFSET)
write_at_offset(firmware, FIRMWARE_OFFSET)

print(f'Merged binary created: {merged}')
"

      - name: Upload merged.bin as artifact
        uses: actions/upload-artifact@v4
        with:
          name: BARA-ESP32-merged-bin
          path: merged.bin
