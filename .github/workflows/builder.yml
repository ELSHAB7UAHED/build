name: ESP32 BARA Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v3
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ðŸ“¦ Cache PlatformIO
      uses: actions/cache@v3
      with:
        path: |
          ~/.platformio
          .pio
        key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-
          
    - name: ðŸ”§ Install PlatformIO
      run: |
        pip install --upgrade platformio
        pio --version
        
    - name: ðŸ“ Create platformio.ini
      run: |
        cat > platformio.ini << 'EOF'
        [env:esp32dev]
        platform = espressif32
        board = esp32dev
        framework = arduino
        monitor_speed = 115200
        
        lib_deps = 
            ESP Async WebServer
            AsyncTCP
            ArduinoJson
            DNSServer
        
        build_flags = 
            -DCORE_DEBUG_LEVEL=0
            -DBOARD_HAS_PSRAM
        
        board_build.partitions = default.csv
        board_build.filesystem = spiffs
        EOF
        
    - name: ðŸ“‚ Prepare Project Structure
      run: |
        mkdir -p src
        mv bara.ino src/bara.ino.cpp
        
    - name: ðŸ”¨ Build Firmware
      run: pio run --environment esp32dev
      
    - name: ðŸŽ¯ Merge Binaries
      run: |
        python -m esptool --chip esp32 merge_bin \
          -o merged.bin \
          --flash_mode dio \
          --flash_freq 40m \
          --flash_size 4MB \
          0x1000 .pio/build/esp32dev/bootloader.bin \
          0x8000 .pio/build/esp32dev/partitions.bin \
          0xe000 ~/.platformio/packages/framework-arduinoespressif32/tools/partitions/boot_app0.bin \
          0x10000 .pio/build/esp32dev/firmware.bin
          
    - name: ðŸ“Š Build Info
      run: |
        echo "âœ… Build completed successfully!"
        echo "ðŸ“¦ Firmware size:"
        ls -lh .pio/build/esp32dev/firmware.bin
        echo "ðŸ“¦ Merged binary size:"
        ls -lh merged.bin
        
    - name: ðŸš€ Upload Merged Binary
      uses: actions/upload-artifact@v4
      with:
        name: bara-firmware
        path: merged.bin
        retention-days: 30
        
    - name: ðŸš€ Upload Individual Binaries
      uses: actions/upload-artifact@v3
      with:
        name: bara-firmware-parts
        path: |
          .pio/build/esp32dev/firmware.bin
          .pio/build/esp32dev/bootloader.bin
          .pio/build/esp32dev/partitions.bin
        retention-days: 30
        
    - name: ðŸ“‹ Generate Flash Instructions
      run: |
        cat > FLASH_INSTRUCTIONS.txt << 'EOF'
        ðŸ”¥ BARA V3.0 - Flashing Instructions
        =====================================
        
        Method 1: Flash merged.bin (Easiest)
        -------------------------------------
        esptool.py --chip esp32 --port COM3 --baud 921600 write_flash 0x0 merged.bin
        
        Method 2: Flash individual binaries
        ------------------------------------
        esptool.py --chip esp32 --port COM3 --baud 921600 write_flash \
          0x1000 bootloader.bin \
          0x8000 partitions.bin \
          0xe000 boot_app0.bin \
          0x10000 firmware.bin
        
        Notes:
        - Replace COM3 with your ESP32 port (COM3, /dev/ttyUSB0, etc.)
        - Use 460800 baud if 921600 fails
        - Hold BOOT button during connection if flashing fails
        
        Web Flash Tool:
        - Visit: https://espressif.github.io/esptool-js/
        - Select merged.bin at offset 0x0
        - Click Connect and Flash
        EOF
        
    - name: ðŸ“„ Upload Flash Instructions
      uses: actions/upload-artifact@v3
      with:
        name: flash-instructions
        path: FLASH_INSTRUCTIONS.txt
        retention-days: 30
