name: ü©∏ BARA V3.0 ‚Äî ULTIMATE ESP32 BUILDER

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger

env:
  PROJECT_NAME: BARA_V3
  SKETCH_PATH: build/bara.ino
  FQBN: esp32:esp32:esp32doit-devkit-v1
  CORE_VERSION: 2.0.17  # Arduino ESP32 Core version
  OUTPUT_BIN: ${{ github.workspace }}/build/BARA_V3_MERGED.bin

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1
        with:
          version: latest

      - name: üíæ Install ESP32 Core
        run: |
          arduino-cli core update-index
          arduino-cli core install esp32:esp32@$CORE_VERSION

      - name: üì¶ Install Required Libraries
        run: |
          arduino-cli lib install \
            "ESPAsyncWebServer" \
            "AsyncTCP" \
            "ArduinoJson" \
            "DNSServer"

      - name: üîç Verify Sketch Path
        run: |
          if [ ! -f "$SKETCH_PATH" ]; then
            echo "‚ùå Sketch not found at $SKETCH_PATH"
            exit 1
          fi
          echo "‚úÖ Sketch found. Building..."

      - name: üß± Compile Project
        run: |
          arduino-cli compile \
            --fqbn $FQBN \
            --output-dir ./build \
            --build-property "compiler.cpp.extra_flags=-DBARA_V3" \
            --warnings all \
            $SKETCH_PATH

      - name: üîó Locate Compiled .bin
        id: find_bin
        run: |
          BIN_FILE=$(find ./build -name "*.ino.bin" | head -n1)
          if [ -z "$BIN_FILE" ]; then
            echo "‚ùå No .bin file found after compilation"
            exit 1
          fi
          echo "BIN_PATH=$BIN_FILE" >> $GITHUB_ENV
          echo "‚úÖ Compiled binary: $BIN_FILE"

      - name: üß¨ Extract Bootloader, Partitions & App
        run: |
          # Download tools
          wget -q https://github.com/espressif/esptool/releases/latest/download/esptool-v4.7.0-linux-amd64.tar.gz
          tar -xzf esptool-v4.7.0-linux-amd64.tar.gz
          sudo mv esptool-v4.7.0-linux-amd64/esptool /usr/local/bin/
          rm -rf esptool-v4.7.0-linux-amd64*

          # Fetch tools from Arduino core
          CORE_PATH=$(arduino-cli core search esp32:esp32 --format json | jq -r '.[0].InstalledPath')
          BOOTLOADER="$CORE_PATH/tools/sdk/esp32/bin/bootloader_dio_40m.bin"
          PARTITIONS="$CORE_PATH/tools/partitions/boot_app0.bin"

          if [ ! -f "$BOOTLOADER" ] || [ ! -f "$PARTITIONS" ]; then
            echo "‚ùå Bootloader or partitions not found in core path"
            exit 1
          fi

          echo "‚úÖ Bootloader: $BOOTLOADER"
          echo "‚úÖ Partitions: $PARTITIONS"

      - name: üî• Merge into Single Binary (0x0)
        run: |
          esptool.py --chip esp32 merge_bin \
            -o $OUTPUT_BIN \
            0x1000 "${{ env.BOOTLOADER }}" \
            0x8000 "${{ env.PARTITIONS }}" \
            0x10000 "${{ env.BIN_PATH }}"

      - name: üì§ Upload Final Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BARA_V3_MERGED.bin
          path: ${{ env.OUTPUT_BIN }}
          retention-days: 7

      - name: ‚úÖ Success Message
        run: |
          echo "ü©∏ BARA V3.0 BUILT SUCCESSFULLY!"
          echo "üìÅ Artifact: BARA_V3_MERGED.bin ready for flashing at 0x0"
