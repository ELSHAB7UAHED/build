name: ğŸ”¥ BARA V3.0 - ESP32 Build Pipeline

on:
  push:
    branches: [ main, master, dev ]
    paths:
      - 'bara.ino'
      - '.github/workflows/builder.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug

env:
  PROJECT_NAME: bara
  ESP32_BOARD: esp32:esp32:esp32
  ARDUINO_CLI_VERSION: latest
  BUILD_DIR: build
  ARTIFACT_NAME: BARA_V3.0_ESP32_Firmware

jobs:
  # ============================================================================
  # ğŸ” PRE-BUILD VALIDATION
  # ============================================================================
  validate:
    name: ğŸ” Validate Source Code
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check INO File Exists
        run: |
          if [ ! -f "bara.ino" ]; then
            echo "âŒ ERROR: bara.ino not found!"
            exit 1
          fi
          echo "âœ… bara.ino found"
          
      - name: ğŸ“Š Code Statistics
        run: |
          echo "ğŸ“Š Project Statistics:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Lines of Code: $(wc -l < bara.ino)"
          echo "ğŸ“¦ File Size: $(du -h bara.ino | cut -f1)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ›¡ï¸ Security Check
        run: |
          echo "ğŸ›¡ï¸ Checking for sensitive data..."
          if grep -i "password\|secret\|token\|api[_-]key" bara.ino | grep -v "AP_PASS\|//"; then
            echo "âš ï¸ WARNING: Potential sensitive data found"
          else
            echo "âœ… No sensitive data detected"
          fi

  # ============================================================================
  # ğŸ—ï¸ BUILD FOR ESP32
  # ============================================================================
  build:
    name: ğŸ—ï¸ Build ESP32 Firmware
    runs-on: ubuntu-latest
    needs: validate
    
    strategy:
      matrix:
        include:
          - board: esp32:esp32:esp32
            board_name: ESP32-DevKit
            partition: default
          - board: esp32:esp32:esp32
            board_name: ESP32-4MB
            partition: min_spiffs

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Cache Arduino CLI
        uses: actions/cache@v4
        with:
          path: |
            ~/.arduino15
            ~/Arduino/libraries
          key: ${{ runner.os }}-arduino-${{ hashFiles('bara.ino') }}
          restore-keys: |
            ${{ runner.os }}-arduino-

      - name: ğŸ”§ Install Arduino CLI
        run: |
          echo "ğŸ”§ Installing Arduino CLI..."
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
          echo "$HOME/bin" >> $GITHUB_PATH
          
      - name: âš™ï¸ Configure Arduino CLI
        run: |
          echo "âš™ï¸ Configuring Arduino CLI..."
          arduino-cli config init
          arduino-cli config set library.enable_unsafe_install true
          
      - name: ğŸ“¦ Install ESP32 Core
        run: |
          echo "ğŸ“¦ Installing ESP32 Board Core..."
          arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli core update-index
          arduino-cli core install esp32:esp32@2.0.17
          arduino-cli core list

      - name: ğŸ“š Install Required Libraries
        run: |
          echo "ğŸ“š Installing required libraries..."
          
          # Core libraries for BARA
          arduino-cli lib install "WiFi@2.0.0" || true
          arduino-cli lib install "ESPAsyncWebServer@1.2.7" || true
          arduino-cli lib install "AsyncTCP@1.1.4" || true
          arduino-cli lib install "ArduinoJson@7.2.1"
          arduino-cli lib install "DNSServer@1.1.1" || true
          
          echo "âœ… All libraries installed successfully"
          echo ""
          echo "ğŸ“‹ Installed Libraries:"
          arduino-cli lib list

      - name: ğŸ”§ Install ESPAsyncWebServer from GitHub
        run: |
          echo "ğŸ”§ Installing ESPAsyncWebServer from source..."
          cd ~/Arduino/libraries
          
          # Remove old version if exists
          rm -rf ESPAsyncWebServer AsyncTCP
          
          # Clone latest versions
          git clone https://github.com/me-no-dev/ESPAsyncWebServer.git
          git clone https://github.com/me-no-dev/AsyncTCP.git
          
          echo "âœ… ESPAsyncWebServer installed"

      - name: ğŸ“ Prepare Build Directory
        run: |
          echo "ğŸ“ Creating build structure..."
          mkdir -p ${{ env.BUILD_DIR }}
          mkdir -p sketches/${{ env.PROJECT_NAME }}
          cp bara.ino sketches/${{ env.PROJECT_NAME }}/${{ env.PROJECT_NAME }}.ino

      - name: ğŸ”¨ Compile Firmware
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¨ Compiling BARA V3.0 for ${{ matrix.board_name }}..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          arduino-cli compile \
            --fqbn ${{ matrix.board }} \
            --output-dir ${{ env.BUILD_DIR }} \
            --build-property "compiler.warning_level=all" \
            --build-property "build.partitions=${{ matrix.partition }}" \
            --verbose \
            sketches/${{ env.PROJECT_NAME }}
            
          echo "âœ… Compilation successful!"

      - name: ğŸ“¦ Generate Merged Binary
        run: |
          echo "ğŸ“¦ Creating merged firmware binary..."
          
          cd ${{ env.BUILD_DIR }}
          
          # Install esptool if not available
          pip3 install esptool
          
          # Merge all binaries into one
          python3 -m esptool \
            --chip esp32 \
            merge_bin \
            -o ${{ env.PROJECT_NAME }}_${{ matrix.board_name }}_merged.bin \
            --flash_mode dio \
            --flash_freq 80m \
            --flash_size 4MB \
            0x1000 ${{ env.PROJECT_NAME }}.ino.bootloader.bin \
            0x8000 ${{ env.PROJECT_NAME }}.ino.partitions.bin \
            0x10000 ${{ env.PROJECT_NAME }}.ino.bin
          
          echo "âœ… Merged binary created successfully!"

      - name: ğŸ“Š Firmware Information
        run: |
          cd ${{ env.BUILD_DIR }}
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š FIRMWARE BUILD INFORMATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ Project: BARA V3.0 - Ultimate ESP32 Warfare Toolkit"
          echo "ğŸ”§ Board: ${{ matrix.board_name }}"
          echo "ğŸ“¦ Partition: ${{ matrix.partition }}"
          echo ""
          echo "ğŸ“ Generated Files:"
          ls -lh *.bin 2>/dev/null || echo "No bin files found"
          echo ""
          echo "ğŸ“ Firmware Sizes:"
          echo "   â€¢ Bootloader: $(du -h ${{ env.PROJECT_NAME }}.ino.bootloader.bin 2>/dev/null | cut -f1 || echo 'N/A')"
          echo "   â€¢ Partitions: $(du -h ${{ env.PROJECT_NAME }}.ino.partitions.bin 2>/dev/null | cut -f1 || echo 'N/A')"
          echo "   â€¢ Application: $(du -h ${{ env.PROJECT_NAME }}.ino.bin 2>/dev/null | cut -f1 || echo 'N/A')"
          echo "   â€¢ Merged (0x0): $(du -h ${{ env.PROJECT_NAME }}_${{ matrix.board_name }}_merged.bin 2>/dev/null | cut -f1 || echo 'N/A')"
          echo ""
          echo "âœ… Build Date: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”– Commit: ${{ github.sha }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ“¤ Upload Firmware Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}_${{ matrix.board_name }}
          path: |
            ${{ env.BUILD_DIR }}/*.bin
            ${{ env.BUILD_DIR }}/*.elf
          retention-days: 30

      - name: ğŸ“¤ Upload Merged Binary (0x0)
        uses: actions/upload-artifact@v4
        with:
          name: Merged_Binary_${{ matrix.board_name }}_0x0
          path: ${{ env.BUILD_DIR }}/${{ env.PROJECT_NAME }}_${{ matrix.board_name }}_merged.bin
          retention-days: 90

  # ============================================================================
  # ğŸ“‹ CREATE RELEASE
  # ============================================================================
  release:
    name: ğŸš€ Create Release
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    permissions:
      contents: write
      
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“Š List Downloaded Files
        run: |
          echo "ğŸ“Š Downloaded artifacts:"
          find artifacts -type f -name "*.bin" -exec ls -lh {} \;

      - name: ğŸ·ï¸ Generate Release Tag
        id: tag
        run: |
          TAG="v3.0-build-$(date +%Y%m%d-%H%M%S)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Release Tag: $TAG"

      - name: ğŸ“ Generate Release Notes
        id: notes
        run: |
          cat > release_notes.md << 'EOF'
          # ğŸ©¸ BARA V3.0 - Ultimate ESP32 Warfare Toolkit
          
          ## ğŸ¯ Release Information
          
          **Build Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          
          ## ğŸ“¦ Firmware Files
          
          ### ğŸ”¥ Merged Binaries (Flash at 0x0)
          Perfect for direct flashing to ESP32:
          - `bara_ESP32-DevKit_merged.bin` - Standard ESP32
          - `bara_ESP32-4MB_merged.bin` - ESP32 with minimal SPIFFS
          
          ### ğŸ“± Individual Binaries
          For advanced users:
          - `bara.ino.bootloader.bin` - Flash at 0x1000
          - `bara.ino.partitions.bin` - Flash at 0x8000
          - `bara.ino.bin` - Flash at 0x10000
          
          ## ğŸš€ Quick Start
          
          ### Method 1: Flash Merged Binary (Easiest)
          ```bash
          esptool.py --chip esp32 --port COM3 write_flash 0x0 bara_ESP32-DevKit_merged.bin
          ```
          
          ### Method 2: Flash Individual Files
          ```bash
          esptool.py --chip esp32 --port COM3 write_flash \
            0x1000 bara.ino.bootloader.bin \
            0x8000 bara.ino.partitions.bin \
            0x10000 bara.ino.bin
          ```
          
          ## ğŸ”§ Features
          
          - âš¡ Advanced Deauthentication Attack System
          - ğŸ” Real-time Network Scanner
          - ğŸ¨ Blood-Matrix Hacker UI with Visual Effects
          - ğŸ“Š Live Attack Statistics
          - ğŸ® Audio Feedback System
          - ğŸŒ Captive Portal Interface
          - ğŸ“± Mobile-Responsive Design
          
          ## âš ï¸ Legal Warning
          
          **FOR AUTHORIZED PENETRATION TESTING ONLY**
          
          Unauthorized use of this tool is illegal and punishable by law. Only use on networks you own or have explicit permission to test.
          
          ## ğŸ“– Documentation
          
          - Connect to WiFi: `BARA_WARFARE`
          - Password: `A7med@Elshab7`
          - Web Interface: `http://192.168.4.1`
          
          ## ğŸ‘¨â€ğŸ’» Developer
          
          Developed by **Ahmed Nour Ahmed** | Qena, Egypt
          
          ---
          
          ğŸ©¸ **BARA V3.0** - Built with â¤ï¸ for the security research community
          EOF
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ğŸ©¸ BARA V3.0 - Build ${{ steps.tag.outputs.tag }}
          body: ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.bin
            artifacts/**/*.elf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # ğŸ“Š BUILD SUMMARY
  # ============================================================================
  summary:
    name: ğŸ“Š Build Summary
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Build Summary
        run: |
          echo "# ğŸ©¸ BARA V3.0 - Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ¯ Project Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** BARA V3.0 - Ultimate ESP32 Warfare Toolkit" >> $GITHUB_STEP_SUMMARY
          echo "- **Developer:** Ahmed Nour Ahmed" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the compiled firmware from the **Artifacts** section above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ©¸ **Built with GitHub Actions**" >> $GITHUB_STEP_SUMMARY
