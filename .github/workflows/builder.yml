name: ğŸ©¸ Build BARA Firmware for ESP32

on:
  workflow_dispatch:
  push:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1

      - name: ğŸ”Œ Install ESP32 Core (v3.3.2)
        run: |
          arduino-cli core update-index --additional-urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
          arduino-cli core install esp32:esp32@3.3.2 --additional-urls https://espressif.github.io/arduino-esp32/package_esp32_index.json

      - name: ğŸ“¦ Install Libraries (Compatible Versions)
        run: |
          # Install ArduinoJson (safe via CLI)
          arduino-cli lib install "ArduinoJson"

          # Install AsyncTCP and ESPAsyncWebServer from source (to ensure compatibility with Core 3.x)
          mkdir -p /home/runner/Arduino/libraries
          git clone -b master --depth=1 https://github.com/me-no-dev/AsyncTCP.git /home/runner/Arduino/libraries/AsyncTCP
          git clone -b master --depth=1 https://github.com/me-no-dev/ESPAsyncWebServer.git /home/runner/Arduino/libraries/ESPAsyncWebServer

      - name: ğŸ› ï¸ Compile BARA
        run: |
          arduino-cli compile \
            --fqbn esp32:esp32:esp32 \
            --build-property compiler.cpp.extra_flags="-build" \
            --output-dir ./build \
            build.ino

      - name: ğŸ“‚ Package Binaries
        run: |
          mkdir -p firmware
          find ./build -name "*firmware*.bin" -exec cp {} ./firmware/build-firmware.bin \; || echo "âš ï¸ Firmware not found"
          find ./build -name "*partitions*.bin" -exec cp {} ./firmware/build-partitions.bin \; || echo "âš ï¸ Partitions not found"
          find ./build -name "*bootloader*.bin" -exec cp {} ./firmware/build-bootloader.bin \; || echo "âš ï¸ Bootloader not found"

      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-binaries
          path: ./firmware/
          retention-days: 30

      - name: ğŸ§¾ Summary
        run: |
          echo "âœ… BARA build succeeded!"
          ls -lh ./firmware/
