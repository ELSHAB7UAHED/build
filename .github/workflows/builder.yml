# =============================================================================
# ğŸ©¸ BARA V3.0 â€” ULTIMATE ESP32 WARFARE BUILDER CONFIG ğŸ©¸
# =============================================================================
# Developed by: Ahmed Nour Ahmed | Qena, Egypt
# Purpose: Automated, professional-grade build pipeline for BARA V3.0
# Output: merged.bin (flashable from 0x0) containing full firmware
# =============================================================================

name: BARA V3.0 Build Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: ğŸ”¥ Build BARA V3.0 Firmware
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ› ï¸ Install PlatformIO Core
        run: |
          pip install --upgrade pip
          pip install platformio

      - name: ğŸ“ Create PlatformIO Project Structure
        run: |
          mkdir -p .pio/src
          mkdir -p .pio/lib
          cp bara.ino .pio/src/main.cpp
          cat > .pio/platformio.ini << 'EOF'
[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
board_build.partitions = min_spiffs.csv
lib_deps =
    me-no-dev/ESP Async WebServer @ ^1.2.3
    bblanchon/ArduinoJson @ ^6.21.1
    ; DNSServer is built-in
build_flags =
    -DCORE_DEBUG_LEVEL=0
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
upload_protocol = espota
EOF

      - name: ğŸ§± Build Firmware
        run: |
          cd .pio
          pio run -e esp32dev

      - name: ğŸ§ª Locate Build Artifacts
        id: artifacts
        run: |
          FW_DIR=$(find .pio/build -name "*.bin" -exec dirname {} \; | head -n1)
          echo "fw_dir=$FW_DIR" >> $GITHUB_OUTPUT
          ls -la "$FW_DIR"

      - name: ğŸ§© Merge Firmware into Single Binary (0x0)
        run: |
          FW_DIR="${{ steps.artifacts.outputs.fw_dir }}"
          cd "$FW_DIR"
          # Download partition table and bootloader if needed
          python3 -c "
import os, sys, struct
offsets = [
    ('bootloader.bin', 0x1000),
    ('partitions.bin', 0x8000),
    ('firmware.bin', 0x10000)
]
merged_size = 0x400000  # 4MB flash
with open('merged.bin', 'wb') as f:
    f.write(b'\\xff' * merged_size)
    for fname, offset in offsets:
        if os.path.exists(fname):
            with open(fname, 'rb') as infile:
                data = infile.read()
                f.seek(offset)
                f.write(data)
                print(f'âœ… Written {fname} at 0x{offset:06x}')
        else:
            print(f'âš ï¸ {fname} not found')
"

      - name: ğŸ“¤ Upload merged.bin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bara-v3.0-esp32-merged-bin
          path: ${{ steps.artifacts.outputs.fw_dir }}/merged.bin
          retention-days: 7

      - name: âœ… Build Summary
        run: |
          echo "ğŸ©¸ BARA V3.0 BUILD SUCCESSFUL!"
          echo "ğŸ“ Download 'merged.bin' from Artifacts to flash directly at 0x0."
          echo "ğŸ”§ Use: esptool.py --chip esp32 write_flash 0x0 merged.bin"
